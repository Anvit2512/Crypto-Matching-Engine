<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Matching Engine — Simple Web UI</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#161a2b; --muted:#8a93b2; --text:#e7ecff; --accent:#6ea8fe; --buy:#19c37d; --sell:#ff6a6a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--panel),rgba(22,26,43,0.85)); border-bottom:1px solid #232742}
    .wrap{max-width:1100px; margin:0 auto; padding:14px 16px}
    h1{font-size:18px; margin:0}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:16px}
    .card{background:var(--panel); border:1px solid #232742; border-radius:12px; overflow:hidden}
    .card h2{font-size:14px; font-weight:600; margin:0; padding:12px 14px; border-bottom:1px solid #232742; color:#cdd5ff}
    .card .content{padding:12px 14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input, select, button, textarea{background:#0f1324; color:var(--text); border:1px solid #2a3057; border-radius:8px; padding:10px 12px; font-size:14px}
    input:focus, select:focus, button:focus{outline:2px solid #3a4aa3; outline-offset:1px}
    button{cursor:pointer; background:linear-gradient(180deg,#2b3b8b,#1e2a64); border-color:#38469a}
    button:hover{filter:brightness(1.05)}
    .muted{color:var(--muted)}
    .flex{display:flex; align-items:center; gap:8px}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid #2a3057; background:#0f1324; font-size:12px}
    .bbo{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .bbo .price{font-variant-numeric:tabular-nums; font-weight:700}
    .price.buy{color:var(--buy)}
    .price.sell{color:var(--sell)}
    table{width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums}
    th,td{padding:8px 6px; border-bottom:1px dashed #22274a; font-size:13px}
    th{color:#b9c1ea; text-align:left}
    tbody tr:hover{background:#131a33}
    .rhs{display:flex; flex-direction:column; gap:16px}
    .log{max-height:260px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; line-height:1.35; background:#0c1020; border:1px solid #232742; border-radius:10px; padding:10px}
    .ok{color:#89f0c3}
    .err{color:#ff8f8f}
    .hint{font-size:12px; color:#a9b2da}
    .hidden{display:none}
    footer{color:var(--muted); text-align:center; padding:16px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap flex" style="justify-content:space-between;">
      <div class="flex" style="gap:10px">
        <h1>Crypto Matching Engine — Simple Web UI</h1>
        <span class="pill">BBO + L2 + Trades + Submit</span>
      </div>
      <div class="flex">
        <label class="muted">Server:</label>
        <input id="baseUrl" value="http://127.0.0.1:8000" style="width:230px"/>
      </div>
    </div>
  </header>

  <main class="wrap">

    <div class="card">
      <div class="content row" style="justify-content:space-between; align-items:center">
        <div class="flex" style="gap:10px; flex-wrap:wrap">
          <label class="muted">Symbol</label>
          <input id="symbol" value="BTC-USDT" style="width:150px"/>
          <button id="connectBtn">Connect Feeds</button>
          <span id="status" class="pill">Disconnected</span>
        </div>
        <div class="bbo">
          <span class="muted">Best Bid</span> <span id="bestBid" class="price buy">—</span>
          <span class="muted">/ Best Ask</span> <span id="bestAsk" class="price sell">—</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h2>Order Book (Top 10)</h2>
        <div class="content">
          <div class="row" style="gap:16px">
            <div style="flex:1">
              <h3 class="muted" style="margin:4px 0">Asks</h3>
              <table id="asksTbl">
                <thead><tr><th>Price</th><th>Qty</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div style="flex:1">
              <h3 class="muted" style="margin:4px 0">Bids</h3>
              <table id="bidsTbl">
                <thead><tr><th>Price</th><th>Qty</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <aside class="rhs">
        <section class="card">
          <h2>Place Order</h2>
          <div class="content">
            <div class="row">
              <select id="orderType">
                <option value="market">market</option>
                <option value="limit" selected>limit</option>
                <option value="ioc">ioc</option>
                <option value="fok">fok</option>
                <option value="stop_market">stop_market</option>
                <option value="stop_limit">stop_limit</option>
                <option value="take_profit">take_profit</option>
              </select>
              <select id="side">
                <option value="buy" selected>buy</option>
                <option value="sell">sell</option>
              </select>
              <input id="qty" placeholder="quantity" value="1.0" style="width:120px"/>
              <input id="px" placeholder="price (limit/ioc/fok/stop_limit)" value="60000" style="width:200px"/>
              <input id="triggerPx" placeholder="trigger_price (stop*/take_profit)" class="hidden" style="width:220px"/>
              <button id="sendBtn">Submit</button>
            </div>
            <p id="tip" class="hint" style="margin-top:8px">
              Tip: For <b>market</b> orders, price is ignored. For <b>limit/IOC/FOK</b>, price is required.
            </p>
            <div class="log" id="respLog" style="margin-top:10px"></div>
          </div>
        </section>

        <section class="card">
          <h2>Trade Tape</h2>
          <div class="content">
            <table id="tradesTbl">
              <thead><tr><th>Time</th><th>Px</th><th>Qty</th><th>Side</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </aside>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>Events</h2>
      <div class="content log" id="eventLog"></div>
    </section>

  </main>

  <footer>
    Built for your Python matching engine • Simple HTML/CSS/JS — now with stops & take-profit.
  </footer>

  <script>
    const el = sel => document.querySelector(sel);
    const bidsT = el('#bidsTbl tbody');
    const asksT = el('#asksTbl tbody');
    const tradesT = el('#tradesTbl tbody');
    const bestBid = el('#bestBid');
    const bestAsk = el('#bestAsk');
    const statusPill = el('#status');
    const eventLog = el('#eventLog');
    const respLog = el('#respLog');
    const orderType = el('#orderType');
    const px = el('#px');
    const trig = el('#triggerPx');
    const tip = el('#tip');

    function fmtTime(iso){
      try{ return new Date(iso).toLocaleTimeString(); }catch{return iso}
    }
    function setStatus(s){ statusPill.textContent = s; }
    function log(line, cls='ok'){
      const d=document.createElement('div'); d.className=cls; d.textContent=line; eventLog.prepend(d);
    }
    function logResp(obj){
      const s = JSON.stringify(obj,null,2); const pre = document.createElement('pre'); pre.textContent = s; respLog.prepend(pre);
    }

    function renderDepth(msg){
      bidsT.innerHTML = '';
      asksT.innerHTML = '';
      const bids = msg.bids || []; const asks = msg.asks || [];
      if(bids.length){ bestBid.textContent = bids[0][0] + ' × ' + bids[0][1]; } else { bestBid.textContent = '—'; }
      if(asks.length){ bestAsk.textContent = asks[0][0] + ' × ' + asks[0][1]; } else { bestAsk.textContent = '—'; }
      for(const [p,q] of asks){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class="price sell">${p}</td><td>${q}</td>`;
        asksT.appendChild(tr);
      }
      for(const [p,q] of bids){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class="price buy">${p}</td><td>${q}</td>`;
        bidsT.appendChild(tr);
      }
    }

    function addTrade(t){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${fmtTime(t.timestamp)}</td><td>${t.price}</td><td>${t.quantity}</td><td class="${t.aggressor_side==='buy'?'price buy':'price sell'}">${t.aggressor_side}</td>`;
      tradesT.prepend(tr);
      while(tradesT.rows.length>50) tradesT.deleteRow(-1);
    }

    // --- WS connections ---
    let mdWS, trWS;

    async function connect(){
      const base = el('#baseUrl').value.replace(/\/$/,'');
      const sym = encodeURIComponent(el('#symbol').value.trim());
      try{
        if(mdWS) mdWS.close(); if(trWS) trWS.close();
        mdWS = new WebSocket(`ws://${base.split('://')[1]}/ws/marketdata?symbol=${sym}`);
        trWS = new WebSocket(`ws://${base.split('://')[1]}/ws/trades?symbol=${sym}`);
        setStatus('Connecting…');

        mdWS.onopen = ()=>{ setStatus('Connected'); log('MD connected'); };
        mdWS.onmessage = (ev)=>{ try{ renderDepth(JSON.parse(ev.data)); }catch{ log('Bad MD payload','err'); } };
        mdWS.onclose = ()=>{ setStatus('Disconnected'); log('MD closed','err'); };

        trWS.onopen = ()=>{ log('Trades connected'); };
        trWS.onmessage = (ev)=>{ try{ addTrade(JSON.parse(ev.data)); }catch{ log('Bad TR payload','err'); } };
        trWS.onclose = ()=>{ log('Trades closed','err'); };
      }catch(err){ setStatus('Error'); log('Connect error: '+err,'err'); }
    }

    // --- UI logic for order type inputs ---
    function refreshHints(){
      const t = orderType.value;
      // Show/hide fields
      // - market: no price, no trigger
      // - limit/ioc/fok: price required, no trigger
      // - stop_market/take_profit: trigger required, price ignored
      // - stop_limit: both trigger and price required
      const showPrice = (t === 'limit' || t === 'ioc' || t === 'fok' || t === 'stop_limit');
      const showTrig  = (t === 'stop_market' || t === 'stop_limit' || t === 'take_profit');

      px.classList.toggle('hidden', !showPrice);
      trig.classList.toggle('hidden', !showTrig);

      if(t === 'market'){
        tip.innerHTML = 'Tip: <b>market</b> ignores price. Use qty & side only.';
      }else if(t === 'limit' || t === 'ioc' || t === 'fok'){
        tip.innerHTML = 'Tip: <b>'+t+'</b> requires <b>price</b>.';
      }else if(t === 'stop_market'){
        tip.innerHTML = 'Tip: <b>stop_market</b> requires <b>trigger_price</b>; sends a child <b>market</b> order when triggered.';
      }else if(t === 'take_profit'){
        tip.innerHTML = 'Tip: <b>take_profit</b> requires <b>trigger_price</b>; sends a child <b>market</b> order when triggered.';
      }else if(t === 'stop_limit'){
        tip.innerHTML = 'Tip: <b>stop_limit</b> requires <b>trigger_price</b> and <b>price</b> (limit).';
      }
    }

    // --- Submit order ---
    async function submitOrder(){
      const base = el('#baseUrl').value.replace(/\/$/,'');
      const payload = {
        symbol: el('#symbol').value.trim(),
        order_type: el('#orderType').value,
        side: el('#side').value,
        quantity: el('#qty').value.trim()
      };

      const t = payload.order_type;
      // include price?
      if (t !== 'market' && t !== 'stop_market' && t !== 'take_profit') {
        payload.price = el('#px').value.trim();
      }
      // include trigger_price?
      if (t === 'stop_market' || t === 'stop_limit' || t === 'take_profit') {
        payload.trigger_price = el('#triggerPx').value.trim();
      }

      // basic front-end validation (helps avoid 422s)
      if(!payload.quantity || Number(payload.quantity) <= 0){
        log('Quantity must be > 0','err'); return;
      }
      if((t === 'limit' || t === 'ioc' || t === 'fok' || t === 'stop_limit') && (!payload.price || Number(payload.price) <= 0)){
        log('Price required and must be > 0 for '+t,'err'); return;
      }
      if((t === 'stop_market' || t === 'stop_limit' || t === 'take_profit') && (!payload.trigger_price || Number(payload.trigger_price) <= 0)){
        log('trigger_price required and must be > 0 for '+t,'err'); return;
      }

      try{
        const r = await fetch(`${base}/orders`,{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const j = await r.json();
        logResp(j);
        if(!r.ok){ log('Order error: '+(j.detail||r.status),'err'); }
        else{ log('Order accepted: '+j.order_id); }
      }catch(err){ log('Request failed: '+err,'err'); }
    }

    // wire UI
    el('#connectBtn').addEventListener('click', connect);
    el('#sendBtn').addEventListener('click', submitOrder);
    el('#orderType').addEventListener('change', refreshHints);

    // Auto-connect on load + set correct hint visibility
    window.addEventListener('load', ()=>{
      refreshHints();
      connect();
    });
  </script>
</body>
</html>
